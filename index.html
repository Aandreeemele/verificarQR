<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Esc√°ner de C√≥digo QR</title>
  <link rel="manifest" href="manifest.json"> 
  <meta name="theme-color" content="#2196f3">

  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      text-align: center;
      background: #000;
      color: white;
      margin: 0;
      padding: 20px;
    }

    h2 { color: #00bcd4; margin-bottom: 8px; font-size: 1.4em; }
    p { color: #bbb; font-size: 0.95em; margin-bottom: 20px; }

    #reader { width: 100%; max-width: 380px; margin: 0 auto 20px; border-radius: 12px; overflow: hidden; display: none; border: 2px solid #00bcd4; }

    #result {
      background: #1a1a1a; color: white; border-radius: 10px; padding: 15px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.4); max-width: 380px; margin: auto; text-align: left; font-size: 0.95em; line-height: 1.4em;
    }

    #result h3 { color: #00e676; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; font-size: 1.1em; }
    .campo { margin: 6px 0; border-bottom: 1px solid #333; padding-bottom: 4px; }
    .campo strong { color: #00bcd4; }

    .accion-btn {
      margin-top: 10px; background: #00e676; color: #000; border: none; padding: 8px 12px;
      border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 8px;
      text-decoration: none; display: inline-block;
    }
    .accion-btn:hover { background: #00c853; }

    button {
      margin-top: 20px; background: #00bcd4; color: #000; border: none; padding: 12px 20px;
      border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; width: 90%; max-width: 380px; transition: all 0.2s;
    }
    button:hover { background: #03a9f4; }

    @media (max-width: 600px) {
      #reader { width: 100%; }
      #result { font-size: 0.9em; padding: 12px; }
      button { font-size: 0.95em; }
    }
  </style>
</head>
<body>

  <h2>üì∑ Esc√°ner de C√≥digo QR</h2>
  <p>Apunta la c√°mara hacia el c√≥digo para leer la informaci√≥n.</p>

  <div id="reader"></div>

  <div id="result">Esperando escaneo...</div>

  <button id="scanButton">Iniciar escaneo</button>

  <script>
    let html5QrCode;

    async function startScanner() {
      document.getElementById("result").innerHTML = "üì° Escaneando...";
      document.getElementById("reader").style.display = "block";
      document.getElementById("scanButton").style.display = "none";

      html5QrCode = new Html5Qrcode("reader");

      await html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess,
        onScanError
      );
    }

    async function onScanSuccess(decodedText) {
      await html5QrCode.stop();
      document.getElementById("reader").style.display = "none";
      document.getElementById("scanButton").style.display = "inline-block";
      document.getElementById("scanButton").innerText = "üì∑ Escanear otro c√≥digo";

      let textoLimpio = decodedText.replace(/\\n/g, "\n");
      let lineas = textoLimpio.split("\n").filter(l => l.trim() !== "");

      let html = `<h3>‚úÖ C√≥digo detectado correctamente</h3>`;
      let numero = "";
      let correo = "";
      let nombre = "";
      let apellido = "";
      let turno = "";

      lineas.forEach(linea => {
  let partes = linea.split(":");

  if (partes.length === 2) {

    let claveOriginal = partes[0].trim();
    let clave = claveOriginal.toLowerCase();
    let valor = partes[1].trim();

    html += `<div class="campo"><strong>${claveOriginal}:</strong> ${valor}</div>`;

    // üì± tel√©fono
    if (clave.includes("tel") || clave.includes("numero") || clave.includes("whatsapp"))
      numero = valor;

    // üìß correo
    if (clave.includes("correo") || clave.includes("email"))
      correo = valor;

    // üë§ nombre
    if (clave.includes("nombre"))
      nombre = valor;

    // üë§ apellido
    if (clave.includes("apellido"))
      apellido = valor;

    // ‚õ™ turno
    if (clave.includes("turno"))
      turno = valor;
    // contrase√±a
    if (clave.includes("contrase√±a"))
      contrase√±a = valor;

        } else {
          html += `<div class="campo">${linea}</div>`;
        }
      });

      // Botones para enviar "Hola Mundo"
      if (numero) {
  const mensajeWhatsApp = encodeURIComponent(
`Estimado(a) ${nombre} ${apellido},

La Hermandad Jes√∫s del Aposento y Se√±or Sepultado confirma su registro correctamente.

üïØÔ∏è Turno asignado: ${turno}
   Contrase√±a del turno: ${contrase√±a}

Que nuestro Se√±or contin√∫e bendiciendo su fe y devoci√≥n.`
);

  html += `<a class="accion-btn" href="https://wa.me/${numero}?text=${mensajeWhatsApp}" target="_blank">üì± WhatsApp Enviar mensaje</a>`;
}

if (correo) {
  const asunto = encodeURIComponent("Registro Hermandad Virgen de la Soledad Mixco");
  const cuerpo = encodeURIComponent(
`Estimado(a) ${nombre} ${apellido},

Su registro ha sido confirmado exitosamente.

Turno asignado: ${turno}
Contrase√±a del turno: ${contrase√±a}

Gracias por formar parte de nuestras actividades procesionales.
Dios le bendiga.`
);

  html += `<a class="accion-btn" href="mailto:${correo}?subject=${asunto}&body=${cuerpo}" target="_blank">üìß Enviar correo</a>`;
}


      document.getElementById("result").innerHTML = html;
    }

    function onScanError(errorMessage) { /* ignorar errores comunes */ }

    document.getElementById("scanButton").addEventListener("click", startScanner);
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
    </script>
    
</body>
</html>

